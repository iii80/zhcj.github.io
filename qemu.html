<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv=Content-Type content="text/html; charset=utf-8">
<meta http-equiv=pragma content=no-cache>
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/font-awesome.min.css" rel="stylesheet">
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<link rel="shortcut icon" href="favicon.ico">
<link rel="bookmark" href="favicon.ico">
<title>QEMU安装使用手册</title>
</head>
<body style="margin:20px">
<p><a href="index.html">返回首页</a></p>
<h2 align=center>QEMU安装使用手册</h2>
<h3>注：网站系统为CentOS 7.7/8.0，使用systemd。</h3>
<p><b>一、安装qemu</b></p>
<p>1、安装依赖</p>
<pre>
yum install flex glib2-devel pixman-devel zlib-devel libcap-devel libattr-devel gcc gcc-c++ make git flex bison bzip2 pam-devel gnutls-devel perl -y
</pre>
<p>2、下载、编译</p>
<pre>
wget https://download.qemu.org/qemu-4.2.0.tar.xz
tar xvf qemu-4.2.0.tar.xz
cd qemu-4.2.0
./configure --prefix=/data/kvm --interp-prefix=/data/kvm/gnemul --enable-kvm --enable-modules --enable-vnc --enable-virtfs --enable-gnutls --enable-auth-pam --disable-bluez --disable-gtk --target-list=i386-softmmu,x86_64-softmmu,i386-linux-user,x86_64-linux-user
make -j5
make install
ln -s /data/kvm/bin/* /usr/local/bin/
</pre>
<p><b>二、创建、启动虚拟机</b></p>
<pre>
mkdir /data/kvm/img
qemu-img create -f qcow2 /data/kvm/img/xp.qcow2 10G
qemu-system-i386 -m 2048 -enable-kvm -machine usb=on -device usb-tablet -vnc :1 /data/kvm/img/xp.qcow2 -cdrom /data/os/xp.iso -device rtl8139,netdev=net0 -soundhw hda -vga virtio -netdev user,id=net0,hostfwd=tcp::2222-:22
#-machine usb=on -device usb-tablet #解决vnc连接时鼠标不同步问题
#-vnc :1 #以主机的5901端口vnc连接虚拟机
#-device rtl8139,netdev=net0 #设置网卡为rtl8139
#-netdev user,id=net0,hostfwd=tcp::2222-:22 #将虚拟机的22端口映射到主机2222端口上
#-soundhw hda #默认声卡，也可以设置为ac97，但需要安装驱动
</pre>
<p>注：qemu旧版中有qemu-kvm模块存在，新版中需要使用kvm特性时候，在qemu-system-x86_64命令中使用--enable-kvm即可。</p>
<p><b>*使用virtio</b></p>
<p>基本过程：先加载一个virtio模式的非系统硬盘和网卡，进入系统后安装驱动，关机后再让系统硬盘和网卡以virtio模式挂载。</p>
<pre>
wget https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/virtio-win-0.1.100/virtio-win-0.1.100.iso
#wget https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/virtio-win-0.1.173-2/virtio-win-0.1.173.iso
#创建一个虚拟硬盘
qemu-img create -f qcow2 /data/kvm/img/virtio.qcow2 1G
#挂载虚拟硬盘、网卡和驱动
qemu-system-i386 -m 2048 -enable-kvm -machine usb=on -device usb-tablet -vnc :1 -drive file=/data/kvm/img/xp.qcow2,format=qcow2 -drive file=/data/kvm/img/virtio.qcow2,format=qcow2,if=virtio -cdrom /data/os/virtio-win-0.1.100.iso -device virtio-net-pci,netdev=net0 -netdev user,id=net0
#重启
qemu-system-i386 -m 2048 -enable-kvm -machine usb=on -device usb-tablet -vnc :1 -drive file=/data/kvm/img/xp.qcow2,format=qcow2,if=virtio
</pre>
<p><b>三、安装libvirt</b></p>
<p>1、安装依赖</p>
<pre>
yum install gnutls-devel libnl-devel libpciaccess-devel yajl-devel device-mapper-devel -y
</pre>
<p>2、下载、编译</p>
<pre>
wget https://libvirt.org/sources/libvirt-5.9.0.tar.xz
tar xvf libvirt-5.9.0.tar.xz
cd libvirt-5.9.0
./configure --prefix=/data/kvm --without-vmware --without-vbox --without-openvz --without-esx --without-lxc --with-yajl --with-qemu
#去掉vmware/vbox/openvz/esx/lxc支持，只支持qemu
make -j5
make install
<p>3、配置</p>
ln -s /data/kvm/bin/* /usr/local/bin/
ln -s /data/kvm/sbin/* /usr/local/bin/
cp src/libvirtd.service /lib/systemd/system/
cp src/libvirtd.socket /lib/systemd/system/
cp src/virtlogd.service /lib/systemd/system/
cp src/virtlogd.socket /lib/systemd/system/
cp src/virtlockd.service /lib/systemd/system/
cp src/virtlockd.socket /lib/systemd/system/
systemctl start libvirtd
systemctl enable libvirtd
</pre>
<p>暂未完成</p>
<p><a href="index.html">返回首页</a></p>
<p align="center">版权所有 &copy; 2016-2019 清风的个人笔记 
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?6383511877c1f3152c86dffde46dd57a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
</p>
</body>
