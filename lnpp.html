<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv=Content-Type content="text/html; charset=utf-8">
<meta http-equiv=pragma content=no-cache>
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/font-awesome.min.css" rel="stylesheet">
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<link rel="shortcut icon" href="favicon.ico">
<link rel="bookmark" href="favicon.ico">
<title>网站LNPP环境安装配置笔记</title>
<style>pre {white-space: pre-wrap;white-space: -moz-pre-wrap;white-space: -pre-wrap;white-space: -o-pre-wrap;word-wrap: break-word;}</style>
</head>
<body style="margin:20px">
<p><a href="index.html">返回首页</a></p>
<h2 align=center>网站LNPP环境安装配置笔记</h2>
<h3>注：网站系统为CentOS 7.6，使用systemd。</h3>
<p><b>一、准备工作：</b></p>
<p>1、升级系统</p>
<pre>yum update -y</pre>
<p>2、清理原有安装</p>
<pre>yum remove php* mariadb* nginx* http* -y</pre>
<p><b>二、测试服务器LNPP编译安装</b></p>
<p><b>1、安装编译工具</b></p>
<pre>yum install gcc cmake gcc-c++ -y</pre>
<p><b>2、安装Nginx</b></p>
<li>安装依赖</li>
<pre>yum install pcre-devel zlib-devel openssl-devel -y
</pre>
<li>建立组和用户并设置不能ssh登录</li>
<pre>groupadd -r www
useradd -r -M -s /bin/false -g www www
sed -i "s/\/home\/www://" /etc/passwd</pre>
<li>下载</li>
<pre>mkdir -p /data/source
cd /data/source
wget http://nginx.org/download/nginx-1.15.8.tar.gz
#wget http://nginx.org/download/nginx-1.14.2.tar.gz</pre>
<li>解压</li>
<pre>tar xvf nginx-1.15.8.tar.gz
#tar xvf nginx-1.14.2.tar.gz</pre>
<li>编译</li>
<pre>cd nginx-1.15.8
#cd nginx-1.14.2
#把nginx提示改成IIS
sed -i "s/center>nginx/center>IIS 7.0/g" src/http/ngx_http_special_response.c
sed -i "s/Server: nginx/Server: IIS 7.0/g" src/http/ngx_http_header_filter_module.c
sed -i "s/nginx version:/IIS version:/g" src/core/nginx.c
sed -i "s/nginx\//IIS\//g" src/core/nginx.h
sed -i "s/1.15.7/7.0/g" src/core/nginx.h
#sed -i "s/1.14.1/7.0/g" src/core/nginx.h
sed -i "s/1015005/2017/g" src/core/nginx.h
#sed -i "s/1013006/2017/g" src/core/nginx.h
sed -i "s/nginx\//IIS\//g" conf/fastcgi*
#修改日志格式
sed -i "s/28\/Sep\/1970:12:00:00 +0600/1970-09-28 12:00:00/g" src/http/modules/ngx_http_log_module.c
sed -i "s/28\/Sep\/1970:12:00:00 +0600/1970-09-28 12:00:00/g" src/core/ngx_times.c
sed -i "s/%02d\/%s\/%d:%02d:%02d:%02d %c%02i%02i/%4d-%02d-%02d %02d:%02d:%02d/g" src/core/ngx_times.c

                       tm.ngx_tm_year, tm.ngx_tm_mon,
                       tm.ngx_tm_mday, tm.ngx_tm_hour,
                       tm.ngx_tm_min, tm.ngx_tm_sec,

./configure --prefix=/data/lnpp/nginx --user=www --group=www --pid-path=/run/nginx.pid --lock-path=/run/nginx.lock --http-client-body-temp-path=/tmp/client --http-proxy-temp-path=/tmp/proxy --http-fastcgi-temp-path=/tmp/fastcgi --http-uwsgi-temp-path=/tmp/uwsgi --http-scgi-temp-path=/tmp/scgi --http-log-path=/data/lnpp/log/nginx/access.log --error-log-path=/data/lnpp/log/nginx/error.log  --with-http_ssl_module --with-http_v2_module --with-stream_realip_module --with-http_stub_status_module
make -j5
make install</pre>
<li>配置启动</li>
<pre>mkdir /usr/lib/systemd/system
cat > /usr/lib/systemd/system/nginx.service << "EOF"
[Unit]
Description=The nginx HTTP and reverse proxy server
After=network.target remote-fs.target nss-lookup.target

[Service]
Type=forking
PIDFile=/run/nginx.pid
ExecStartPre=/data/lnpp/nginx/sbin/nginx -t -c /data/lnpp/nginx/conf/nginx.conf
ExecStart=/data/lnpp/nginx/sbin/nginx -c /data/lnpp/nginx/conf/nginx.conf
ExecReload=/bin/kill -HUP $MAINPID
ExecStop=/bin/kill -QUIT $MAINPID

[Install]
WantedBy=multi-user.target
EOF

sed -i "s/\/\$nginx_version//" /data/lnpp/nginx/conf/fastcgi*
sed -i "s/}/    application\/vnd.android.package-archive apk;\n}/g" /data/lnpp/nginx/conf/mime.types
mv /data/lnpp/nginx/conf/nginx.conf /data/lnpp/nginx/conf/nginx.conf.bak
mkdir /data/lnpp/nginx/conf/conf.d

cat > /data/lnpp/nginx/conf/nginx.conf << "EOF"
user  www;
worker_processes  4;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    charset  utf-8;
    sendfile        on;
    client_max_body_size 40m;
    server_tokens off;
    keepalive_timeout  65;
    gzip  on;
    include  conf.d/*.conf;
}
EOF
cat > /data/lnpp/nginx/conf/conf.d/www.conf << "EOF"
server {
    listen       80;
    server_name  localhost;
    root   /data/www;
    index  index.html index.htm index.php;

    error_page  404              /404.html;
    error_page   500 502 503 504  /50x.html;

    location / {
        try_files $uri $uri/ /index.php$is_args$args;
    }

    location ~ \.php$ {
        try_files $uri = 404;
        fastcgi_pass   127.0.0.1:9000;
        include        fastcgi.conf;
    }
}
EOF
mkdir /data/www
ln -s /data/lnpp/nginx/sbin/nginx /usr/local/bin/
</pre>
<li>打开防火墙</li>
<pre>firewall-cmd --permanent --zone=public --add-service=http
firewall-cmd --reload</pre>
<p><b>3.1、yum安装PostgreSQL数据库</b></p>
<li>加源</li>
<pre>rpm -ivh https://download.postgresql.org/pub/repos/yum/11/redhat/rhel-7-x86_64/pgdg-centos11-11-2.noarch.rpm</pre>
<li>安装</li>
<pre>yum install postgresql11-server postgresql11-devel</pre>
<li>初始化数据库</li>
<pre>/usr/pgsql-11/bin/postgresql-11-setup initdb</pre>
<li>设置密码</li>
<pre>echo "密码" | passwd --stdin postgres</pre>
<li>数据库管理工具Adminer：<a href="https://www.adminer.org/" target="_blank">https://www.adminer.org/</a></li>
<p><b>3.2、编译安装PostgreSQL数据库</b></p>
<li>建立组和用户并设置密码</li>
<pre>groupadd -r postgres
useradd -r -M -s /bin/nologin -g postgres -d /data/lnpp/pgsql postgres
echo "密码" | passwd --stdin postgres</pre>
<li>安装依赖</li>
<pre>yum install pam-devel readline-devel libxslt-devel</pre>
<li>下载</li>
<pre>wget https://ftp.postgresql.org/pub/source/v11.1/postgresql-11.1.tar.bz2</pre>
<li>解压</li>
<pre>tar xvf postgresql-11.1.tar.bz2</pre>
<li>编译</li>
<pre>cd postgresql-11.1
./configure --prefix=/data/lnpp/pgsql --datadir=/data/lnpp/pgsql/data --with-system-tzdata=/usr/share/zoneinfo --enable-spinlocks --disable-thread-safety --without-gssapi --without-llvm --with-pam --without-perl --without-python --with-readline --with-openssl --with-systemd --without-tcl --with-libxml --with-libxslt --with-zlib --enable-nls='zh_CN'
make -j5
make install</pre>
<li>初始化数据库</li>
<pre>chown postgres:postgres /data/lnpp/pgsql/data -R
sudo -u postgres /data/lnpp/pgsql/bin/initdb -D /data/lnpp/pgsql/data/11 -E 'UTF-8' --lc-collate='zh_CN.UTF-8' --lc-ctype='zh_CN.UTF-8'</pre>
<li>配置文件</li>
<pre>cat > /lib/systemd/system/postgresql.service << "EOF"
[Unit]
Description=PostgreSQL database server
After=network.target

[Service]
Type=notify

User=postgres
Group=postgres

Environment=DATA_DIR=/data/lnpp/pgsql/data/11

ExecStart=/data/lnpp/pgsql/bin/postgres -D ${DATA_DIR}
ExecReload=/bin/kill -HUP $MAINPID
KillMode=mixed
KillSignal=SIGINT

TimeoutSec=300

OOMScoreAdjust=-1000

[Install]
WantedBy=multi-user.target
EOF</pre>
<li>启动数据库</li>
<pre>systemctl start postgresql
systemctl enable postgresql</pre>
<p><b>4.1、yum安装PHP</b></p>
<pre>yum install yum-utils
yum install http://rpms.remirepo.net/enterprise/remi-release-7.rpm
yum-config-manager --enable remi-php73
yum install php-fpm php-opcache php-gd php-pg php-cli php-mbstring php-xml php-pecl-zip php-intl php-ldap php-smbclient php-imap php-exif php-gmp php-redis php-imagick
systemctl enable php-fpm
systemctl start php-fpm</pre>
<p><b>4.2、编译安装PHP</b></p>
<li>安装依赖</li>
<pre>yum install libxml2-devel systemd-devel gd-devel libcurl-devel openldap-devel -y</pre>
<li>下载</li>
<pre>cd /data/source
wget http://cn2.php.net/distributions/php-5.6.39.tar.xz
#wget http://cn2.php.net/distributions/php-7.2.14.tar.xz
#wget http://cn2.php.net/distributions/php-7.3.1.tar.xz</pre>
<li>解压</li>
<pre>tar xvf php-5.6.39.tar.xz
#tar xvf php-7.2.14.tar.xz</pre>
#tar xvf php-7.3.1.tar.xz</pre>
<li>编译</li>
<pre>cd php-5.6.39
#cd php-7.2.14
#cd php-7.3.1
./configure --prefix=/data/lnpp/php --enable-fpm --with-fpm-systemd --with-fpm-user=www --with-fpm-group=www --with-config-file-path=/data/lnpp/php --with-config-file-scan-dir=/data/lnpp/php/lib/php/extensions --enable-opcache --disable-ipv6 --enable-mbstring --with-gettext --with-curl --enable-mysqlnd --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd --disable-phpdbg --with-gd --with-freetype-dir --with-png-dir --with-xpm-dir --with-jpeg-dir --with-zlib --enable-calendar --enable-exif --enable-ftp --enable-zip --without-libzip --enable-soap --enable-bcmath --enable-sockets --with-openssl --with-pgsql --with-pdo-pgsql --with-ldap --with-ldap-sasl --with-mysql
ln -s /usr/lib64/libldap* /usr/lib/
ln -s /usr/lib64/liblber* /usr/lib/
#php-7.2/7.3去掉--with-mysql
make -j5
make install
#make时出现：PEAR package PHP_Archive not installed: generated phar will require PHP's phar extension be enabled.
#make install之后，运行以下命令，再次make && make install就可以了
/data/lnpp/php/bin/pear channel-update pear.php.net
ln -s /data/lnpp/php/bin/* /usr/local/bin/
ln -s /data/lnpp/php/sbin/* /usr/local/bin/
cp sapi/fpm/php-fpm.service /usr/lib/systemd/system/
sed -i "s/\${prefix}/\/data\/lnpp\/php/" /usr/lib/systemd/system/php-fpm.service
sed -i "s/\${exec_prefix}/\/data\/lnpp\/php/" /usr/lib/systemd/system/php-fpm.service
sed -i "s/\/data\/php\/var\/run/\/run/" /usr/lib/systemd/system/php-fpm.service
#cp sapi/fpm/www.conf /data/lnpp/php/etc/php-fpm.d/
cp sapi/fpm/php-fpm.conf /data/lnpp/php/etc/
echo "zend_extension=/data/lnpp/php/lib/php/extensions/no-debug-non-zts-20131226/opcache.so" > /data/lnpp/php/lib/php/extensions/opcache.ini
#php-7.2
#echo "zend_extension=/data/lnpp/php/lib/php/extensions/no-debug-non-zts-20170718/opcache.so" > /data/lnpp/php/lib/php/extensions/opcache.ini
#php-7.3
#echo "zend_extension=/data/lnpp/php/lib/php/extensions/no-debug-non-zts-20180731/opcache.so" > /data/lnpp/php/lib/php/extensions/opcache.ini
cp php.ini-production /data/lnpp/php/php.ini
sed -i "s/;opcache.enable=0/opcache.enable=1/" /data/lnpp/php/php.ini
sed -i "s/;opcache.enable=1/opcache.enable=1/" /data/lnpp/php/php.ini
sed -i "s/;opcache.enable_cli=0/opcache.enable_cli=1/" /data/lnpp/php/php.ini
sed -i "s/;opcache.file_cache=/opcache.file_cache=\/tmp/" /data/lnpp/php/php.ini
sed -i "s/max_execution_time = 30/max_execution_time = 60/" /data/lnpp/php/php.ini
sed -i "s/upload_max_filesize = 2M/upload_max_filesize = 20M/" /data/lnpp/php/php.ini
sed -i "s/post_max_size = 8M/post_max_size = 20M/" /data/lnpp/php/php.ini
sed -i "s/display_errors = Off/display_errors = On/" /data/lnpp/php/php.ini
sed -i "s/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/" /data/lnpp/php/php.ini
sed -i "s/;date.timezone =/date.timezone = Asia\/Shanghai/" /data/lnpp/php/php.ini
sed -i "s/expose_php = On/expose_php = Off/" /data/lnpp/php/php.ini
sed -i "s/;error_log = log\/php-fpm.log/error_log = \/data\/lnpp\/log\/php\/php-fpm.log/" /data/lnpp/php/etc/php-fpm.conf
sed -i "s/;slowlog = log\/\$pool.log.slow/slowlog = \/data\/lnpp\/log\/php\/slow.log/g" /data/lnpp/php/etc/php-fpm.conf
sed -i "s/;request_slowlog_timeout = 0/request_slowlog_timeout = 300/g" /data/lnpp/php/etc/php-fpm.conf
mkdir /data/lnpp/log/php
</pre>
#与php7共存时，php5的编译及配置过程
<pre>
./configure --prefix=/data/lnpp/php5 --enable-fpm --with-fpm-systemd --with-fpm-user=www --with-fpm-group=www --with-config-file-path=/data/lnpp/php5 --with-config-file-scan-dir=/data/lnpp/php5/lib/php/extensions --enable-opcache --disable-ipv6 --enable-mbstring --with-gettext --with-curl --enable-mysqlnd --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd --disable-phpdbg --with-gd --with-freetype-dir --with-png-dir --with-xpm-dir --with-jpeg-dir --with-zlib --enable-calendar --enable-exif --enable-ftp --enable-zip --enable-soap --enable-bcmath --enable-sockets --with-openssl --with-mysql --enable-pcntl

cp sapi/fpm/php-fpm.service /usr/lib/systemd/system/php-fpm5.service
sed -i "s/\${prefix}/\/data\/lnpp\/php5/" /usr/lib/systemd/system/php-fpm5.service
sed -i "s/\${exec_prefix}/\/data\/lnpp\/php5/" /usr/lib/systemd/system/php-fpm5.service
sed -i "s/\/data\/php\/var\/run/\/run/" /usr/lib/systemd/system/php-fpm5.service
cp sapi/fpm/php-fpm.conf /data/lnpp/php5/etc/
echo "zend_extension=/data/lnpp/php5/lib/php/extensions/no-debug-non-zts-20131226/opcache.so" > /data/lnpp/php5/lib/php/extensions/opcache.ini
cp php.ini-production /data/lnpp/php5/php.ini
sed -i "s/;opcache.enable=0/opcache.enable=1/" /data/lnpp/php5/php.ini
sed -i "s/;opcache.enable_cli=0/opcache.enable_cli=1/" /data/lnpp/php5/php.ini
sed -i "s/max_execution_time = 30/max_execution_time = 60/" /data/lnpp/php5/php.ini
sed -i "s/upload_max_filesize = 2M/upload_max_filesize = 20M/" /data/lnpp/php5/php.ini
sed -i "s/post_max_size = 8M/post_max_size = 20M/" /data/lnpp/php5/php.ini
sed -i "s/display_errors = Off/display_errors = On/" /data/lnpp/php5/php.ini
sed -i "s/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/" /data/lnpp/php5/php.ini
sed -i "s/;date.timezone =/date.timezone = Asia\/Shanghai/" /data/lnpp/php5/php.ini
sed -i "s/expose_php = On/expose_php = Off/" /data/lnpp/php5/php.ini
sed -i "s/;error_log = log\/php-fpm.log/error_log = \/data\/lnpp\/log\/php\/php-fpm.log/" /data/lnpp/php5/etc/php-fpm.conf
sed -i "s/;slowlog = log\/\$pool.log.slow/slowlog = \/data\/lnpp\/log\/php\/slow.log/g" /data/lnpp/php5/etc/php-fpm.conf
sed -i "s/;request_slowlog_timeout = 0/request_slowlog_timeout = 300/g" /data/lnpp/php5/etc/php-fpm.conf
mkdir /data/lnpp/log/php</pre>
#安装memcached，并设置开机运行
<pre>
yum install memcached -y
systemctl start memcached
systemctl enable memcached
</pre>
#安装libmemcached
<pre>
cd /data/source
wget https://launchpad.net/libmemcached/1.0/1.0.18/+download/libmemcached-1.0.18.tar.gz
tar xvf libmemcached-1.0.18.tar.gz
cd libmemcached-1.0.18
./configure --prefix=/data/lnpp/lib --with-memcached
make -j5
make install
</pre>
#pecl安装php模块（最简单的方法）
<pre>pecl install memcached redis lzf imagick</pre>
#安装php的memcached模块
<pre>
yum install autoconf -y
cd /data/source
wget https://pecl.php.net/get/memcached-2.2.0.tgz
#wget https://pecl.php.net/get/memcached-3.0.3.tgz
#php7.0
tar xvf memcached-2.2.0.tgz
#tar xvf memcached-3.0.3.tgz
cd memcached-2.2.0
#cd memcached-3.0.3
/data/lnpp/php/bin/phpize
#/data/lnpp/php7/bin/phpize
./configure --with-php-config=/data/lnpp/php/bin/php-config --enable-memcached --with-libmemcached-dir=/data/lnpp/lib --disable-memcached-sasl
#./configure --with-php-config=/data/lnpp/php7/bin/php-config --enable-memcached --with-libmemcached-dir=/data/lnpp/lib --disable-memcached-sasl
make -j5
make install
echo "extension=/data/lnpp/php/lib/php/extensions/no-debug-non-zts-20131226/memcached.so" > /data/lnpp/php/lib/php/extensions/memcached.ini 
#echo "extension=/data/lnpp/php7/lib/php/extensions/no-debug-non-zts-20151012/memcached.so" > /data/lnpp/php7/lib/php/extensions/memcached.ini 
</pre>
#安装redis服务，并设置开机运行
方式一：yum安装（版本旧）
<pre>
yum install redis
systemctl start redis
systemctl enable redis
</pre>
方式二：编译安装
<pre>
wget http://download.redis.io/releases/redis-5.0.3.tar.gz
tar xvf redis-5.0.3.tar.gz
cd redis-5.0.3
make
make PREFIX=/data/lnpp/redis install
cp redis.conf /data/lnpp/redis/
groupadd -r redis
useradd -r -M -s /bin/false -g redis redis
sed -i "s/\/home\/redis://" /etc/passwd
cat > /usr/lib/systemd/system/redis.service << "EOF"
[Unit]
Description=Redis persistent key-value database
After=network.target

[Service]
ExecStart=/data/lnpp/redis/bin/redis-server /data/lnpp/redis/redis.conf --daemonize no
ExecStop=/data/lnpp/redis/bin/redis-cli -h 127.0.0.1 -p 6379 shutdown
User=redis
Group=redis
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
ln -s /data/lnpp/redis/bin/* /usr/local/bin/
#Failed opening the RDB file dump.rdb问题
mkdir /data/lnpp/redis/db
chown redis:redis /data/lnpp/redis/db -R
sed -i "s/dir .\//dir \/data\/lnpp\/redis\/db\//g" /data/lnpp/redis/redis.conf
#The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.问题
echo 511 > /proc/sys/net/core/somaxconn
echo "echo 511 > /proc/sys/net/core/somaxconn" >> /etc/rc.local
#MISCONF Redis is configured to save RDB snapshots, but is currently not able to persist on disk问题
echo "vm.overcommit_memory = 1" >> /etc/sysctl.conf
sysctl -p
echo 1 > /proc/sys/vm/overcommit_memory
# WARNING you have Transparent Huge Pages (THP) support enabled in your kernel.问题
echo never > /sys/kernel/mm/transparent_hugepage/enabled
echo "echo never > /sys/kernel/mm/transparent_hugepage/enabled" /etc/rc.local
systemctl start redis
systemctl enable redis
</pre>
#安装php的redis模块
<pre>
wget http://pecl.php.net/get/redis-4.2.0.tgz
tar xvf redis-4.2.0.tar.tgz
cd redis-4.2.0
yum install autoconfig -y
/data/lnpp/php/bin/phpize
./configure --with-php-config=/data/lnpp/php/bin/php-config
make -j5
make install
echo "extension=/data/lnpp/php/lib/php/extensions/no-debug-non-zts-20131226/redis.so" > /data/lnpp/php/lib/php/extensions/redis.ini 
#echo "extension=/data/lnpp/php7/lib/php/extensions/no-debug-non-zts-20160303/redis.so" > /data/lnpp/php/lib/php/extensions/redis.ini 
</pre>
#安装php的apcu模块
<pre>
cd /data/source
wget https://pecl.php.net/get/apcu-4.0.11.tgz
tar xvf apcu-4.0.11.tgz
cd apcu-4.0.11
/data/lnpp/php/bin/phpize
./configure --enable-apcu --with-php-config=/data/lnpp/php/bin/php-config
make -j5
make install
echo "extension=/data/lnpp/php/lib/php/extensions/no-debug-non-zts-20131226/apcu.so" > /data/lnpp/php/lib/php/extensions/apcu.ini 
</pre>
安装php的suhosin模块禁用eval(php7.1，不支持7.2/7.3)
<pre>
git clone https://github.com/sektioneins/suhosin7.git
cd suhosin7
phpize
./configure
make
make install
echo "extension=/data/lnpp/php/lib/php/extensions/no-debug-non-zts-20160303/suhosin7.so" > /data/lnpp/php/lib/php/extensions/suhosin7.ini
echo "[Suhosin]" >> /data/lnpp/php/php.ini
echo "suhosin.executor.disable_eval = On" >> /data/lnpp/php/php.ini
echo "suhosin.executor.eval.blacklist=phpinfo,fputs,fopen,fwrite" >> /data/lnpp/php/php.ini
</pre>
<p>检查是否成功</p>
<pre>php -m|grep memcache
php -m|grep apc
php -i|grep memcache
php -i|grep apc
php -i|grep suhosin</pre>
<p><a href="index.html">返回首页</a></p>
<p align="center">版权所有 &copy; 2016-2019 清风的个人笔记 <script src="http://s11.cnzz.com/stat.php?id=3406730&web_id=3406730&show=pic1" language="JavaScript"></script></p>
</body>
</html>
